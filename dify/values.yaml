# Dify Helm values (RAG: Qdrant rag NS, MinIO devops NS, Ingress)
# install.sh substitutes k8s_project, k8s_domain before use
# PVC: NFS StorageClass (nfs-client) for api/worker shared ReadWriteMany

image:
  api:
    repository: langgenius/dify-api
    tag: "1.11.4"
    pullPolicy: IfNotPresent
  web:
    repository: langgenius/dify-web
    tag: "1.11.4"
    pullPolicy: IfNotPresent
  sandbox:
    repository: langgenius/dify-sandbox
    tag: "0.2.12"
    pullPolicy: IfNotPresent
  proxy:
    repository: nginx
    tag: latest
    pullPolicy: IfNotPresent

# Vector DB: use existing RAG Qdrant (rag namespace)
api:
  extraEnv:
    # OAuth redirect/callback base URL (chart ConfigMap often has these empty → Google 400). install.sh replaces DIFY_BASE_URL_REPLACE.
    - name: CONSOLE_API_URL
      value: "DIFY_BASE_URL_REPLACE"
    # - name: CONSOLE_WEB_URL
    #   value: "DIFY_BASE_URL_REPLACE"
    - name: SERVICE_API_URL
      value: "DIFY_BASE_URL_REPLACE"
    - name: APP_WEB_URL
      value: "DIFY_BASE_URL_REPLACE"
    - name: APP_API_URL
      value: "DIFY_BASE_URL_REPLACE"
    # Plugin/Webhook trigger callback base URL (defaults to http://localhost:5001 if unset). Must be public URL.
    - name: TRIGGER_URL
      value: "DIFY_BASE_URL_REPLACE"
    # Plugin (e.g. dify_extractor) fetches files from this URL; must be reachable from plugin-daemon pod.
    # See: https://github.com/langgenius/dify-official-plugins/issues/1816
    - name: FILES_URL
      value: "http://dify-api:5001"
    - name: CHECK_UPDATE_URL
      value: ""
    - name: VECTOR_STORE
      value: "qdrant"
    - name: QDRANT_URL
      value: "http://qdrant.rag.svc.cluster.local:6333"
    - name: QDRANT_API_KEY
      value: ""
    # MinIO(S3) — OpenDAL reads only OPENDAL_S3_*. Secret: S3_ACCESS_KEY, S3_SECRET_KEY
    - name: STORAGE_TYPE
      value: "opendal"
    - name: OPENDAL_SCHEME
      value: "s3"
    - name: OPENDAL_S3_BUCKET
      value: "dify"
    - name: OPENDAL_S3_ENDPOINT
      value: "http://minio.devops.svc.cluster.local:9000"
    - name: OPENDAL_S3_REGION
      value: "us-east-1"
    - name: OPENDAL_S3_ACCESS_KEY_ID
      valueFrom:
        secretKeyRef:
          name: dify-minio-secret
          key: S3_ACCESS_KEY
    - name: OPENDAL_S3_SECRET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: dify-minio-secret
          key: S3_SECRET_KEY
    # OpenTelemetry: disabled — gunicorn+gevent causes "Failed to detach context" (OTel contextvars vs greenlets). Set "true" when collector is ready and if Dify fixes gevent compatibility.
    - name: ENABLE_OTEL
      value: "false"
    - name: OTLP_TRACE_ENDPOINT
      value: ""
    - name: OTLP_METRIC_ENDPOINT
      value: ""
    - name: OTLP_BASE_ENDPOINT
      value: "http://opentelemetry-collector.opentelemetry-operator.svc.cluster.local:4318"
    - name: OTLP_API_KEY
      value: ""
    - name: OTEL_EXPORTER_OTLP_PROTOCOL
      value: "http"
    - name: OTEL_EXPORTER_TYPE
      value: "otlp"
    - name: OTEL_SAMPLING_RATE
      value: "0.1"
    - name: OTEL_BATCH_EXPORT_SCHEDULE_DELAY
      value: "5000"
    - name: OTEL_MAX_QUEUE_SIZE
      value: "2048"
    - name: OTEL_MAX_EXPORT_BATCH_SIZE
      value: "512"
    - name: OTEL_METRIC_EXPORT_INTERVAL
      value: "60000"
    - name: OTEL_BATCH_EXPORT_TIMEOUT
      value: "10000"
    - name: OTEL_METRIC_EXPORT_TIMEOUT
      value: "30000"
    - name: OTEL_SERVICE_NAME
      value: "dify-api"
  # Base URL for access. If empty, redirect/CORS errors and port-forward/Ingress won't work.
  # install.sh replaces DIFY_BASE_URL_REPLACE with actual URL (default: https://dify.k8s_domain)
  # For port-forward only: DIFY_BASE_URL=http://localhost:8080 bash install.sh
  url:
    consoleApi: "DIFY_BASE_URL_REPLACE"
    consoleWeb: "DIFY_BASE_URL_REPLACE"
    serviceApi: "DIFY_BASE_URL_REPLACE"
    appApi: "DIFY_BASE_URL_REPLACE"
    appWeb: "DIFY_BASE_URL_REPLACE"
    files: "DIFY_BASE_URL_REPLACE"
  # Must match existing dify-api Secret SECRET_KEY or all sessions break after upgrade.
  # Get current: kubectl get secret -n dify dify-api -o jsonpath='{.data.SECRET_KEY}' | base64 -d
  secretKey: "sk-dify-REPLACE-WITH-CLUSTER-VALUE"
  migration: true
  # NFS PVC (RWX) for api/worker shared. NFS provisioner must be installed first (dynamic-provisioning/nfs)
  persistence:
    persistentVolumeClaim:
      storageClass: "nfs-client"
      accessModes: ReadWriteMany
      size: 5Gi

worker:
  extraEnv:
    # Same as api: file URLs passed to plugins must be reachable from plugin-daemon.
    - name: FILES_URL
      value: "http://dify-api:5001"
    - name: VECTOR_STORE
      value: "qdrant"
    - name: QDRANT_URL
      value: "http://qdrant.rag.svc.cluster.local:6333"
    - name: QDRANT_API_KEY
      value: ""
    - name: STORAGE_TYPE
      value: "opendal"
    - name: OPENDAL_SCHEME
      value: "s3"
    - name: OPENDAL_S3_BUCKET
      value: "dify"
    - name: OPENDAL_S3_ENDPOINT
      value: "http://minio.devops.svc.cluster.local:9000"
    - name: OPENDAL_S3_REGION
      value: "us-east-1"
    - name: OPENDAL_S3_ACCESS_KEY_ID
      valueFrom:
        secretKeyRef:
          name: dify-minio-secret
          key: S3_ACCESS_KEY
    - name: OPENDAL_S3_SECRET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: dify-minio-secret
          key: S3_SECRET_KEY
    # OpenTelemetry: disabled — gunicorn+gevent causes "Failed to detach context" (OTel contextvars vs greenlets). Set "true" when collector is ready and if Dify fixes gevent compatibility.
    - name: ENABLE_OTEL
      value: "false"
    - name: OTLP_TRACE_ENDPOINT
      value: ""
    - name: OTLP_METRIC_ENDPOINT
      value: ""
    - name: OTLP_BASE_ENDPOINT
      value: "http://opentelemetry-collector.opentelemetry-operator.svc.cluster.local:4318"
    - name: OTLP_API_KEY
      value: ""
    - name: OTEL_EXPORTER_OTLP_PROTOCOL
      value: "http"
    - name: OTEL_EXPORTER_TYPE
      value: "otlp"
    - name: OTEL_SAMPLING_RATE
      value: "0.1"
    - name: OTEL_BATCH_EXPORT_SCHEDULE_DELAY
      value: "5000"
    - name: OTEL_MAX_QUEUE_SIZE
      value: "2048"
    - name: OTEL_MAX_EXPORT_BATCH_SIZE
      value: "512"
    - name: OTEL_METRIC_EXPORT_INTERVAL
      value: "60000"
    - name: OTEL_BATCH_EXPORT_TIMEOUT
      value: "10000"
    - name: OTEL_METRIC_EXPORT_TIMEOUT
      value: "30000"
    - name: OTEL_SERVICE_NAME
      value: "dify-worker"

# Use built-in PostgreSQL, Redis (chart defaults)
postgresql:
  enabled: true
  auth:
    replicationPassword: "difyai123456"
  global:
    storageClass: ""
    postgresql:
      auth:
        postgresPassword: "difyai123456"
        replicationPassword: "difyai123456"
        database: "dify"
  # Avoid "too many clients already" from api/worker/replicas (Bitnami subchart)
  primary:
    extendedConfiguration: |
      max_connections = 200

redis:
  enabled: true
  auth:
    password: "difyai123456"

# Disable Weaviate (using Qdrant)
weaviate:
  enabled: false

# pluginDaemon also uses NFS shared storage (RWX)
pluginDaemon:
  persistence:
    persistentVolumeClaim:
      storageClass: "nfs-client"
      accessModes: ReadWriteMany
      size: 5Gi

# Ingress: apply separately via dify-ingress.yaml (install.sh substitutes k8s_project/k8s_domain)
ingress:
  enabled: false

service:
  type: ClusterIP
  port: 80
