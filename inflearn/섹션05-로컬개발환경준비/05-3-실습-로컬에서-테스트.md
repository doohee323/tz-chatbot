# 05-3. 실습: 로컬에서 테스트

## 목표

- **chat-gateway**와 **chat-admin**을 로컬에서 실행하고, JWT 발급·채팅 페이지가 동작하는지 확인합니다.  
  (K8s 배포 없이 동작 확인용입니다.)

## 전제

- Python 3.11+ 설치
- Dify가 이미 떠 있다면 `DIFY_BASE_URL`, `DIFY_API_KEY` 설정. 없으면 mock/테스트 모드로 UI만 확인 가능할 수 있음
- `CHAT_GATEWAY_JWT_SECRET` 설정 (JWT 서명용)

## chat-gateway 로컬 실행

### 옵션 1: 스크립트 사용

```bash
cd chat-gateway
./gateway.sh
```

- 기본 포트 **8088**로 서버 기동
- 브라우저에서 `http://localhost:8088/` 로 소개 페이지 확인

### 옵션 2: 수동 실행 (스크립트 없을 시)

```bash
cd chat-gateway
# 가상환경 설정
python -m venv .venv
source .venv/bin/activate   # Windows: .venv\Scripts\activate
pip install -r requirements.txt

# 환경변수 설정 (필요시)
export DIFY_BASE_URL="http://localhost:8000"  # 또는 실제 Dify URL
export DIFY_API_KEY="your-dify-api-key"
export CHAT_GATEWAY_JWT_SECRET="your-jwt-secret"
export CHAT_GATEWAY_PORT=8088  # 포트 변경 가능

# 서버 실행
python -m uvicorn main:app --host 0.0.0.0 --port $CHAT_GATEWAY_PORT --reload
```

### 포트 변경 (필요시)

`gateway.sh` 또는 환경변수로 포트 변경:
```bash
export CHAT_GATEWAY_PORT=8089   # 8088 대신 8089 사용
./gateway.sh
```

## JWT 발급 (테스트용)

```bash
cd chat-gateway
./scripts/gen-jwt.sh
# 또는
./scripts/gen-jwt.sh cointutor 999
```

- 출력된 URL(`http://localhost:8088/chat?token=...`)을 브라우저에서 열어 채팅 페이지 접근 가능 여부 확인

## chat-admin 로컬 실행

### 옵션 1: 스크립트 사용

```bash
cd chat-admin
./admin.sh
```

- 기본 포트 **8000**으로 기동
- 브라우저에서 `http://localhost:8000/` 접속

### 옵션 2: 수동 실행 (스크립트 없을 시)

```bash
cd chat-admin
# 가상환경 설정
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt

# 환경변수 설정 (필요시)
export CHAT_GATEWAY_JWT_SECRET="your-jwt-secret"
export CHAT_ADMIN_PORT=8000
export DATABASE_URL="sqlite:///./chat_admin.db"  # 로컬: SQLite

# 서버 실행
python -m uvicorn main:app --host 0.0.0.0 --port $CHAT_ADMIN_PORT --reload
```

### chat-admin의 기능

- **관리자**: 우측 상단 "회원가입" → username/password 입력 후 가입 → 로그인
- **시스템 관리**: 로그인 후 시스템(앱) 목록 추가·수정·삭제, Dify URL·API Key 설정
- **채팅 조회**: system_id·user_id로 대화 조회 (chat-gateway가 저장한 대화)
- **RAG 업로드**: MinIO에 파일 업로드, 재색인 실행

## 확인 사항

- [ ] gateway 루트(/) 소개 페이지가 보인다
- [ ] JWT URL로 `/chat` 페이지가 열린다
- [ ] admin 루트(/) 접속 후 로그인·시스템 목록(또는 빈 목록)이 보인다

이렇게 로컬에서 동작을 확인한 뒤, 실제 서비스는 K8s에 배포하는 흐름을 섹션 10에서 다룹니다.
