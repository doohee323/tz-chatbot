# 05. 전체 데이터 플로우

## 채팅 한 번 보낼 때 (온라인)

1. **클라이언트 앱**(DrillQuiz/CoinTutor 등) → **chat-gateway** (`/v1/chat` 등)에 메시지 전송 (JWT 또는 API Key)
2. **chat-gateway** → **Dify** API로 채팅 전달 (system_id에 따라 Dify 앱·API Key 선택)
3. **Dify** → 필요 시 **RAG Backend** 도구 호출 (질의 텍스트 전달)
4. **RAG Backend** → **Qdrant**에서 유사 벡터 검색 → 청크 반환 → Dify로 전달
5. **Dify** → LLM이 RAG 결과를 참고해 답변 생성 → chat-gateway로 응답
6. **chat-gateway** → DB에 대화·메시지 저장 (설정에 따라), 클라이언트에 응답

## 문서가 RAG에 반영될 때 (오프라인·배치)

1. 문서를 **MinIO** `rag-docs/raw/{토픽}/` 에 업로드 (관리 화면 또는 직접)
2. **RAG Ingestion** (Job/CronJob): MinIO에서 읽기 → **LangChain** Loader·Splitter·Embedding → **Qdrant**에 upsert
3. 이후 사용자 질의 시 RAG Backend가 이 컬렉션에서 검색

## 정리

- **온라인**: 클라이언트 → gateway → Dify → (RAG Backend → Qdrant) → Dify → gateway → 클라이언트
- **오프라인**: MinIO → Ingestion → Qdrant. 관리 화면에서 업로드·재색인 트리거 가능
