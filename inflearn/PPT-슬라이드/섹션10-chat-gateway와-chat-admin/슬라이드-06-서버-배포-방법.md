# 슬라이드 06: 서버 배포 방법

## 슬라이드 내용 (한 장)

**CI 스크립트 (k8s.sh)**  
• chat-admin / chat-gateway 각각 `ci/k8s.sh` — GIT_BRANCH·NAMESPACE로 매니페스트 치환 후 `kubectl apply`  
• 실행: `./ci/k8s.sh <BUILD_NUMBER> <GIT_BRANCH> <NAMESPACE> deploy`

**Jenkins 사용 시**  
• Multibranch Pipeline → Push 시 빌드 → 이미지 푸시 → k8s.sh deploy  
• 브랜치별 NS: main→devops, dev→devops-dev, qa→devops 등

**Jenkins 없이 로컬 배포**  
• **ci.sh**: 빌드+배포 한 번에. KUBECONFIG, GIT_BRANCH, NAMESPACE, CHAT_GATEWAY_JWT_SECRET, DIFY_API_KEY, POSTGRES_PASSWORD 등 환경변수 설정 후 `cd chat-gateway && ./ci/ci.sh`, `cd chat-admin && ./ci/ci.sh`  
• **k8s.sh만**: 이미지 있을 때 배포만 — `./ci/k8s.sh latest main devops deploy`  
• **다른 CI**: GitHub Actions 등에서 동일하게 k8s.sh 호출, credential은 CI Secrets로

**배포 순서**: 인프라(bootstrap) → DB(chat_admin) → Secret → 앱 배포(k8s.sh 또는 ci.sh) → Ingress

---

## 발표 노트

서버 배포 방법을 정리하겠습니다. 기준이 되는 것은 CI 스크립트인 k8s.sh입니다. chat-admin과 chat-gateway 각각 ci 폴더에 k8s.sh가 있고, BUILD_NUMBER, GIT_BRANCH, NAMESPACE를 인자로 받아서 매니페스트를 치환한 뒤 kubectl apply로 배포합니다. 보통 GIT_BRANCH에 따라 네임스페이스나 Secret 접미사가 main, qa, dev처럼 바뀌도록 되어 있습니다.

Jenkins를 사용하시는 경우에는 Multibranch Pipeline으로 저장소를 두고, Push가 되면 웹훅으로 Jenkins가 빌드를 돌리고, 이미지를 빌드·푸시한 다음 k8s.sh deploy를 호출하는 흐름입니다. 브랜치별로 네임스페이스가 나뉘는데, main은 devops, dev는 devops-dev, qa는 devops 또는 devops-qa처럼 저장소와 Jenkinsfile에 정의된 대로 적용하시면 됩니다.

Jenkins를 쓰지 않으시는 분들도 동일하게 배포하실 수 있습니다. 첫째, ci.sh를 쓰는 방법입니다. ci.sh는 Jenkins 파이프라인을 로컬에서 시뮬레이션하는 스크립트입니다. KUBECONFIG를 비롯해 GIT_BRANCH, NAMESPACE, CHAT_GATEWAY_JWT_SECRET, DIFY_API_KEY, chat-admin이면 POSTGRES_PASSWORD 등 Jenkins에 credential로 두던 값들을 환경변수로 설정한 뒤, chat-gateway 디렉터리에서 ./ci/ci.sh, chat-admin 디렉터리에서 ./ci/ci.sh를 실행하면 이미지 빌드·푸시와 k8s.sh 배포가 한 번에 진행됩니다. 둘째, 이미지가 이미 레지스트리에 있거나 같은 태그를 쓸 때는 k8s.sh만 호출하면 됩니다. 예를 들어 ./ci/k8s.sh latest main devops deploy 를 실행하시면 배포만 됩니다. BUILD_NUMBER 자리에는 사용할 이미지 태그를 넣으시고, 필요한 시크릿은 환경변수나 ENV_FILE로 전달하시면 됩니다. 셋째, Jenkins 대신 GitHub Actions 같은 다른 CI를 쓰시면, 그쪽에서 이미지 빌드·푸시 후 같은 k8s.sh를 호출하시면 됩니다. credential은 해당 CI의 Secrets에 넣어 두시면 됩니다.

배포 순서는 인프라, 즉 bootstrap.sh로 Ingress·MinIO·RAG·Dify를 올린 뒤, PostgreSQL에 chat_admin DB를 만들고 접속 정보를 준비하고, chat-admin·chat-gateway용 Secret을 만든 다음, k8s.sh 또는 ci.sh로 앱을 배포하고, admin·gateway용 Ingress 규칙이 필요하면 적용하시면 됩니다. 자세한 변수나 폴더 구조는 각 ci 디렉터리와 Jenkinsfile을 참고하시면 됩니다.
