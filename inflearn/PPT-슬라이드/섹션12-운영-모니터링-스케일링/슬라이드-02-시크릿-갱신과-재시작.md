# 슬라이드 02: 시크릿 갱신과 재시작

## 슬라이드 내용 (한 장)

**Secret 변경 시 Pod 재시작**
• **RAG Ingestion Secret** (MinIO, API Key): 변경 후 RAG Backend Pod 재시작
  ```bash
  kubectl rollout restart deployment/rag-backend deployment/rag-backend-drillquiz -n rag
  ```
• **Ingestion Job/CronJob**: 다음 실행 시 새 Secret 읽음 (이미 돌아가는 Job은 기동 시점 Secret 사용)
• **chat-admin / chat-gateway**: DB 비밀번호·Dify API Key·JWT Secret 변경 시 재시작
  ```bash
  kubectl rollout restart deployment/chat-admin deployment/chat-gateway -n devops
  ```

**안전한 갱신 순서**
1. Secret을 새 값으로 `kubectl apply` 또는 `kubectl create secret ... --dry-run=client -o yaml | kubectl apply -f -`
2. 해당 Secret을 참조하는 Deployment를 `rollout restart`
3. Pod가 새로 뜨는지 확인: `kubectl get pods -n <ns> -w`
4. 로그로 기동·연결 오류 없는지 확인

---

## 발표 노트

운영하면서 Secret 값을 바꿔야 할 경우가 자주 있습니다. 예를 들어 MinIO 접근 키가 바뀌거나, Dify API Key를 갱신했으면 Secret을 업데이트합니다. Secret을 변경했다고 해서 이미 떠 있는 Pod가 자동으로 새 값을 읽지는 않습니다. 기동할 때 Secret을 읽으니까, Pod를 재시작해야 새 Secret이 반영됩니다.

RAG Ingestion Secret을 변경했으면 rag-backend와 rag-backend-drillquiz Deployment를 kubectl rollout restart로 재시작하세요. Ingestion Job과 CronJob은 다음 실행 때부터 새 Secret을 읽습니다. 하지만 지금 돌아가는 중인 Job이 있다면 그 Job은 기동할 때 읽은 기존 Secret을 계속 씁니다.

chat-admin이나 chat-gateway는 DB 비밀번호, Dify API Key, JWT Secret 같은 것들을 Secret에서 읽습니다. 이걸 바꿨으면 chat-admin과 chat-gateway Deployment를 재시작해야 합니다. kubectl rollout restart로 하면 자동으로 새 Pod가 뜨고 기존 Pod는 없어집니다.

갱신 순서가 중요합니다. 먼저 kubectl apply로 Secret을 새 값으로 업데이트하고, 그 다음 해당 Secret을 쓰는 Deployment를 rollout restart합니다. 그러면 Pod가 자동으로 재시작되고, 새 Pod가 새 Secret을 읽습니다. kubectl get pods -n <ns> -w로 Pod가 올라오는지 지켜보고, 로그를 확인해서 연결 오류가 없는지 봅니다.
