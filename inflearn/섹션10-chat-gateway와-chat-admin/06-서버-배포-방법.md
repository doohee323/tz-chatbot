# 06. 서버 배포 방법

## CI 스크립트 (k8s.sh)

- **chat-admin**: `chat-admin/ci/k8s.sh` — 브랜치에 따라 매니페스트 치환 후 `kubectl apply`
- **chat-gateway**: `chat-gateway/ci/k8s.sh` — 동일
- 보통 **GIT_BRANCH** 등으로 네임스페이스·Secret 접미사(-main, -qa, -dev)를 바꿈
- 로컬에서 실행: `cd chat-admin && ./ci/k8s.sh` (또는 ci 폴더 내 스크립트 확인)

## Jenkins

- **Multibranch Pipeline** 등으로 저장소 브랜치별 빌드·배포
- Push 시 웹훅으로 Jenkins가 빌드 → 이미지 빌드 → K8s 배포 (매니페스트는 ci/*.yaml 사용)
- 브랜치별 네임스페이스: main → devops, dev → devops-dev, qa → devops 또는 devops-qa (저장소·Jenkinsfile 확인)

## Jenkins 없이 로컬 배포

Jenkins를 쓰지 않아도 **ci.sh** 또는 **k8s.sh**만으로 동일하게 배포할 수 있습니다.

### 1) ci.sh로 한 번에 (빌드 + 배포)

- **chat-gateway**: `chat-gateway/ci/ci.sh` — Jenkins 파이프라인을 로컬에서 시뮬레이션 (이미지 빌드·푸시 후 k8s.sh deploy)
- **chat-admin**: `chat-admin/ci/ci.sh` — 동일
- 환경변수 설정 후 실행:
  ```bash
  export KUBECONFIG=~/.kube/config
  export GIT_BRANCH=main
  export NAMESPACE=devops
  export CHAT_GATEWAY_JWT_SECRET="your-jwt-secret"
  export DIFY_API_KEY="your-dify-api-key"
  export POSTGRES_PASSWORD="..."   # chat-admin 시 필요
  cd chat-gateway && ./ci/ci.sh
  cd chat-admin   && ./ci/ci.sh
  ```
- Jenkins에 두던 credential(JWT, Dify API Key, DB 비밀번호 등)을 **환경변수**로 넘기면 됨

### 2) k8s.sh만 직접 실행 (배포만)

- 이미지는 이미 레지스트리에 있거나 같은 태그를 쓸 때:
  ```bash
  ./ci/k8s.sh <BUILD_NUMBER> <GIT_BRANCH> <NAMESPACE> deploy [ENV_FILE]
  ```
- 예: `./ci/k8s.sh latest main devops deploy`
- BUILD_NUMBER = 사용할 이미지 태그. 필요한 시크릿은 환경변수 또는 ENV_FILE로 전달

### 3) 다른 CI (GitHub Actions 등)

- Jenkins 대신 GitHub Actions 등에서 이미지 빌드·푸시 후, 동일하게 **k8s.sh**를 호출하면 됨. 필요한 값은 CI Secrets로 설정

## 배포 순서

1. **인프라**: Ingress, MinIO, RAG, Dify (bootstrap.sh)
2. **DB**: PostgreSQL에 `chat_admin` 생성, 접속 정보 준비
3. **Secret**: chat-admin·chat-gateway용 Secret (DB 비밀번호, Dify API Key, JWT Secret 등) 생성
4. **앱 배포**: k8s.sh 또는 Jenkins로 chat-admin·chat-gateway Deployment 적용
5. **Ingress**: admin·gateway용 Ingress 규칙이 있으면 적용

자세한 변수·폴더 구조는 각 `ci/` 디렉터리와 Jenkinsfile을 참고하세요.
